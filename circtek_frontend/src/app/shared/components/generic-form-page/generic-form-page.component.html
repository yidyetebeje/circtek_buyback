<!-- Main Container -->
<div class="min-h-screen bg-base-200 transition-colors duration-300 flex flex-col items-center">
  <div class="container mx-auto px-4 py-8">
    <!-- Card Container -->
    <div class="card-container rounded-2xl border border-base-300/50 max-w-7xl mx-auto">
      <div class="p-6 md:p-8">
        <!-- Header Section -->
        <div class="flex justify-between items-start mb-8">
          <div class="flex items-center gap-4">
            @if (showBackButton()) {
              <button 
                type="button" 
                class="btn btn-ghost btn-sm" 
                (click)="navigateBack()"
              >
                <lucide-icon [img]="ArrowLeft" class="size-4"></lucide-icon>
                Back
              </button>
            }
            <div>
              <h1 class="text-3xl font-bold text-base-content">{{ title() }}</h1>
              @if (subtitle()) {
                <p class="text-base-content/60 mt-1">{{ subtitle() }}</p>
              }
            </div>
          </div>
        </div>

        <!-- Form Card with Shadow -->
        <div class=" bg-base-100 rounded-xl border border-base-300/20 p-6 md:p-8">
        
        <!-- Error Banner -->
        @if (error()) {
          <div class="alert alert-error mb-6">
            <span>{{ error() }}</span>
          </div>
        }

        <!-- Form -->
        <form [formGroup]="form()" (ngSubmit)="onSubmit()" class="space-y-6">
          <!-- Form Fields -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            @for (field of fields(); track field.key) {
              <div [class]="field.type === 'textarea' ? 'md:col-span-2' : ''">
                <label class="label">
                  <span class="label-text font-medium">
                    {{ field.label }}
                    @if (field.required) {
                      <span class="text-error">*</span>
                    }
                  </span>
                </label>

                @switch (field.type) {
                  @case ('select') {
                    <select 
                      [formControlName]="field.key"
                      class="select select-bordered w-full"
                      [class.select-error]="isFieldInvalid(field)"
                      [disabled]="field.disabled || loading() || submitting()"
                    >
                      <option [ngValue]="null" disabled>Select {{ field.label }}</option>
                      @for (option of field.options; track option.value) {
                        <option [ngValue]="option.value">{{ option.label }}</option>
                      }
                    </select>
                  }
                  @case ('textarea') {
                    <textarea 
                      [formControlName]="field.key"
                      class="textarea textarea-bordered w-full placeholder:text-base-content/50 placeholder:font-normal"
                      [class.textarea-error]="isFieldInvalid(field)"
                      [placeholder]="field.placeholder || ''"
                      [disabled]="field.disabled || loading() || submitting()"
                      [maxlength]="field.validation?.maxLength || null"
                      rows="4"
                    ></textarea>
                  }
                  @case ('checkbox') {
                    <div class="form-control">
                      <label class="label cursor-pointer justify-start gap-3">
                        <input 
                          type="checkbox"
                          [formControlName]="field.key"
                          class="checkbox checkbox-primary"
                          [disabled]="field.disabled || loading() || submitting()"
                        />
                        <span class="label-text">{{ field.placeholder || field.label }}</span>
                      </label>
                    </div>
                  }
                  @case ('radio') {
                    <div class="form-control">
                      <div class="space-y-2">
                        @for (option of field.options; track option.value) {
                          <label class="label cursor-pointer justify-start gap-3">
                            <input 
                              type="radio"
                              [formControlName]="field.key"
                              [value]="option.value"
                              class="radio radio-primary"
                              [disabled]="field.disabled || loading() || submitting()"
                            />
                            <span class="label-text">{{ option.label }}</span>
                          </label>
                        }
                      </div>
                    </div>
                  }
                  @case ('file') {
                    <app-file-upload
                      [formControlName]="field.key"
                      [accept]="field.validation?.pattern || '.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif'"
                      [folder]="'purchases'"
                    ></app-file-upload>
                  }
                  @default {
                    <input 
                      [type]="field.type"
                      [formControlName]="field.key"
                      class="input input-bordered w-full placeholder:text-base-content/50 placeholder:font-normal"
                      [class.input-error]="isFieldInvalid(field)"
                      [placeholder]="field.placeholder || ''"
                      [disabled]="field.disabled || loading() || submitting()"
                      [maxlength]="field.validation?.maxLength || null"
                    />
                  }
                }

                @if (getFieldError(field); as error) {
                  <div class="label">
                    <span class="label-text-alt text-error">{{ error }}</span>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Custom Content Projection -->
          <ng-content></ng-content>

          <!-- Action Buttons -->
          <div class="flex justify-end gap-4 pt-6">
            @for (action of actions(); track action.label) {
              <button 
                [type]="action.type"
                [class]="getButtonClass(action)"
                [disabled]="loading() || submitting() || action.disabled"
                (click)="onActionClick(action)"
              >
                @if (action.type === 'submit' && submitting()) {
                  <span class="loading loading-spinner loading-sm"></span>
                } @else {
                  @if (action.type === 'submit') {
                    <lucide-icon [img]="Save" class="size-4"></lucide-icon>
                  }
                  {{ action.label }}
                }
              </button>
            }
            <button 
             type="submit"
             [disabled]="loading() || submitting()"
             (click)="onActionClick({ label: submitLabel(), type: 'submit', variant: 'primary' })"
             [class]="getButtonClass({ label: submitLabel(), type: 'submit', variant: 'primary' })"
            >
             @if (submitting()) {
              <span class="loading loading-spinner loading-sm"></span>
             } @else {
              <lucide-icon [img]="Save" class="size-4"></lucide-icon>
             {{ submitLabel()}}
             }
            </button>
          </div>
        </form>

        <!-- Loading Overlay -->
        @if (loading()) {
          <div class="absolute inset-0 bg-base-100/50 backdrop-blur-sm flex items-center justify-center z-10">
            <span class="loading loading-spinner loading-lg text-primary"></span>
          </div>
        }
      </div>
    </div>
  </div>
</div>
