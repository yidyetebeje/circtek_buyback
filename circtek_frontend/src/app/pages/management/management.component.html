<app-generic-page
  [title]="'Management'"
  [loading]="loading()"
  [tabs]="tabs()"
  [activeTabKeyInput]="activeTab()"
  [facets]="facets()"
  [columns]="columns()"
  [data]="data()"
  [total]="total()"
  [pageIndexInput]="pageIndex()"
  [pageSizeInput]="pageSize()"
  [searchPlaceholder]="searchPlaceholder()"
  [primaryAction]="primaryAction()"
  (primaryActionClick)="onPrimaryActionClick()"
  (pageChange)="onPageChange($event)"
  (filtersChange)="onFiltersChange($event)"
  (sortingChange)="onSortingChange($event)"
  (tabChange)="onTabChange($event)"
  (cellAction)="onCellAction($event)"
></app-generic-page>

<!-- Assign Tester Modal -->
<app-generic-modal
  [isOpen]="isAssignModalOpen()"
  [title]="'Assign Tester'"
  [actions]="assignModalActions()"
  size="md"
  (close)="closeAssignModal()"
  (actionClick)="onAssignModalAction($event)"
>
  <div class="space-y-4">
    <!-- Context information based on active tab -->
    <div class="text-sm text-base-content/70">
      @if (activeTab() === 'wifi' && selectedWifiProfile(); as p) {
        <div><span class="font-medium">Profile:</span> {{ p.name }} (SSID: {{ p.ssid }})</div>
      }
      @if (activeTab() === 'labels' && selectedLabelTemplate(); as l) {
        <div><span class="font-medium">Label Template:</span> {{ l.name }}</div>
      }
      @if (activeTab() === 'workflows' && selectedWorkflow(); as w) {
        <div><span class="font-medium">Workflow:</span> {{ w.name }}</div>
      }
    </div>
    
    <!-- WiFi Profile dropdown only for wifi tab when no profile is selected -->
    @if (activeTab() === 'wifi' && !selectedWifiProfile()) {
      <div class="form-control">
        <label class="label mb-1"><span class="label-text">WiFi Profile</span></label>
        <select 
          class="select select-bordered" 
          (change)="onAssignProfileSelect($event)"
          [disabled]="loading()"
        >
          <option [value]="''">Select WiFi profile…</option>
          @for (opt of wifiOptions(); track opt.value) {
            <option [value]="opt.value">{{ opt.label }}</option>
          }
        </select>
      </div>
    }
    
    <!-- Tester selection -->
    <div class="form-control">
      <label class="label mb-1"><span class="label-text">Tester</span></label>
      <select 
        class="select select-bordered" 
        (change)="onAssignTesterSelect($event)" 
        [value]="selectedAssignTesterId() ?? ''"
        [disabled]="loading()"
      >
        <option value="">Select a tester…</option>
        @for (opt of testerOptions(); track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
      @if (loading()) {
        <div class="text-xs text-base-content/60 mt-1">
          <span class="loading loading-spinner loading-xs"></span>
          Loading testers...
        </div>
      }
    </div>
  </div>
</app-generic-modal>

<!-- View Assigned Testers Modal -->
<app-generic-modal
  [isOpen]="isAssignedModalOpen()"
  [title]="'Assigned Testers'"
  [actions]="assignedModalActions()"
  size="lg"
  (close)="closeAssignedModal()"
  (actionClick)="onAssignedModalAction($event)"
>
  <div class="text-sm text-base-content/70 mb-3">
    @if (activeTab() === 'wifi' && selectedWifiProfile(); as p) {
      <div><span class="font-medium">Profile:</span> {{ p.name }} (SSID: {{ p.ssid }})</div>
    }
    @if (activeTab() === 'labels' && selectedLabelTemplate(); as l) {
      <div><span class="font-medium">Label Template:</span> {{ l.name }}</div>
    }
    @if (activeTab() === 'workflows' && selectedWorkflow(); as w) {
      <div><span class="font-medium">Workflow:</span> {{ w.name }}</div>
    }
  </div>
  @if (assignedTestersLoading()) {
    <div class="flex items-center justify-center py-8">
      <span class="loading loading-spinner loading-md mr-2"></span>
      <span class="text-base-content/70">Loading assigned testers...</span>
    </div>
  } @else {
    <div class="overflow-x-auto border rounded-box">
      <table class="table w-full">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Name</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (u of assignedTesters(); track u.id) {
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.user_name }}</td>
              <td>{{ u.name }}</td>
              <td class="text-right">
                <button 
                  class="btn btn-ghost btn-xs text-error" 
                  [disabled]="loading() || assignedTestersLoading()"
                  [class.loading]="loading()"
                  (click)="unassignTester(u.id)"
                >
                  @if (loading()) {
                    <span class="loading loading-spinner loading-xs"></span>
                  } @else {
                    Unassign
                  }
                </button>
              </td>
            </tr>
          }
          @if (!assignedTesters().length) {
            <tr>
              <td colspan="4" class="text-center py-4 text-base-content/60">No testers assigned.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</app-generic-modal>

<!-- Delete Confirmation Modal -->
<app-generic-modal
  [isOpen]="isDeleteModalOpen()"
  [title]="'Confirm Deletion'"
  [actions]="deleteModalActions()"
  size="md"
  (close)="closeDeleteModal()"
  (actionClick)="onDeleteModalAction($event)"
>
  <div class="text-sm text-base-content/70">
    @if (deleteContext(); as ctx) {
      <p>Are you sure you want to delete this {{ ctx.tab.slice(0, -1) }}? This action cannot be undone.</p>
    }
  </div>
</app-generic-modal>
