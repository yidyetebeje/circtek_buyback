<app-generic-form-page
  title="Receive Product Order"
  subtitle="Scan and receive items from purchase orders"
  [form]="form"
  [fields]="[]"
  [loading]="loading() || loadingSpecificPurchase()"
  [submitting]="submitting()"
  [error]="error()"
  submitLabel="Submit Received Order"
  (formSubmit)="onSubmit()"
  (backClick)="onCancel()"
>
  <!-- Auto-selection message -->
  @if (autoSelectionMessage()) {
    <div class="alert alert-success mb-6">
      <lucide-icon [img]="CheckCircle2" class="size-5"></lucide-icon>
      <span>{{ autoSelectionMessage() }}</span>
    </div>
  }

  <!-- Loading message for specific purchase -->
  @if (loadingSpecificPurchase()) {
    <div class="alert alert-info mb-6">
      <span class="loading loading-spinner loading-sm"></span>
      <span>{{ loadingMessage() }}</span>
    </div>
  }

  <!-- Custom form content -->
  <div class="space-y-6" [formGroup]="form">
    <!-- Purchase Order Selection -->
    <div class="card bg-base-100 border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-lg">Select Purchase Order</h3>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Supplier Order No<span class="text-error">*</span></span>
          </label>
          <select 
            formControlName="purchase_id"
            class="select select-bordered select-accent w-full"
            [class.select-error]="form.get('purchase_id')?.invalid && form.get('purchase_id')?.touched"
            [disabled]="loading() || loadingSpecificPurchase() || submitting()"
          >
            <option value="">Select Supplier Order</option>
            @for (option of purchaseOptions(); track option.value) {
              <option [value]="option.value" [title]="option.label">{{ option.label }}</option>
            }
          </select>
          @if (form.get('purchase_id')?.invalid && form.get('purchase_id')?.touched) {
            <div class="label">
              <span class="label-text-alt text-error">Supplier Order is required</span>
            </div>
          }
        </div>

        <!-- Purchase Information -->
        @if (selectedPurchase()) {
          <div class="divider"></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-base-content/60">Supplier:</span>
              <p class="font-medium">{{ selectedPurchase()!.purchase.supplier_name }}</p>
            </div>
            <div>
              <span class="text-base-content/60">Warehouse:</span>
              <p class="font-medium">Warehouse {{ selectedPurchase()!.purchase.warehouse_id }}</p>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Items to Receive -->
    @if (selectedPurchase() && allItems().length > 0) {
      <div class="card bg-base-100 border border-base-300">
        <div class="card-body">
          <!-- Header with Progress -->
          <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
            <h3 class="card-title text-lg">Items to Receive</h3>
            <div class="flex items-center gap-4">
              <button 
                type="button"
                class="btn btn-sm"
                [class.btn-outline]="!anyItemsSelected()"
                [class.btn-error]="anyItemsSelected() && allItemsSelected()"
                [class.btn-accent]="anyItemsSelected() && !allItemsSelected()"
                (click)="toggleSelectAll()"
                [disabled]="loading() || loadingSpecificPurchase() || submitting()"
              >
                @if (allItemsSelected()) {
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                  Unselect All
                } @else if (anyItemsSelected()) {
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Select All ({{ receiveProgress().total - selectedItemsCount() }} more)
                } @else {
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Select All
                }
              </button>
              <div class="text-sm text-base-content/60">
                Selected: 
                <span class="font-semibold" [class.text-error]="selectedItemsCount() === 0" [class.text-success]="selectedItemsCount() === receiveProgress().total">
                  {{ selectedItemsCount() }}
                </span>
                /{{ receiveProgress().total }} | 
                Progress: 
                <span class="font-semibold" [class.text-success]="receiveProgress().completed === selectedItemsCount() && selectedItemsCount() > 0">
                  {{ receiveProgress().completed }}
                </span>
                /{{ selectedItemsCount() }}
              </div>
              @if (selectedItemsCount() > 0) {
                <div class="radial-progress text-accent" [style.--value]="receiveProgress().percentage" [style.--size]="'3rem'">
                  {{ receiveProgress().percentage }}%
                </div>
              } @else {
                <div class="radial-progress text-base-300" [style.--value]="0" [style.--size]="'3rem'">
                  0%
                </div>
              }
            </div>
          </div>

          

          <!-- Items Table -->
          <div class="overflow-x-auto" formArrayName="items">
            <table class="table table-zebra w-full">
              <thead>
                <tr>
                  <th class="w-12">
                    <label class="cursor-pointer">
                      <input 
                        type="checkbox" 
                        class="checkbox checkbox-sm checkbox-accent"
                        [checked]="allItemsSelected()"
                        [indeterminate]="anyItemsSelected() && !allItemsSelected()"
                        (change)="toggleSelectAll()"
                        [disabled]="loading() || loadingSpecificPurchase() || submitting()"
                      />
                    </label>
                  </th>
                  <th class="w-12"></th>
                  <th>Type</th>
                  <th>SKU</th>
                  <th class="text-center">Remaining</th>
                  <th class="text-center">To Receive</th>
                  <th class="w-12"></th>
                </tr>
              </thead>
              <tbody>
                @for (itemControl of allItems(); track getItemIndex(itemControl); let idx = $index) {
                  @let itemIndex = getItemIndex(itemControl);
                  @let isPart = itemControl.get('is_part')?.value;
                  @let isExpanded = isDeviceExpanded(itemIndex);
                  @let identifiersCount = getIdentifiersArray(itemIndex).length;
                  @let quantity = itemControl.get('quantity_received')?.value || 0;
                  @let isComplete = isPart ? quantity > 0 : identifiersCount > 0;
                  @let isSelected = itemControl.get('selected')?.value;

                  <tr [formGroupName]="itemIndex" class="hover" [class.bg-success/10]="isComplete && isSelected" [class.opacity-50]="!isSelected">
                    <!-- Checkbox -->
                    <td>
                      <input 
                        type="checkbox"
                        formControlName="selected"
                        class="checkbox checkbox-sm checkbox-accent"
                        [disabled]="loading() || loadingSpecificPurchase() || submitting()"
                      />
                    </td>

                    <!-- Status Icon -->
                    <td>
                      @if (isComplete) {
                        <lucide-icon [img]="CheckCircle2" class="size-5 text-success"></lucide-icon>
                      } @else {
                        <div class="size-5 rounded-full border-2 border-base-300"></div>
                      }
                    </td>

                    <!-- Type Icon & Badge -->
                    <td>
                      <div class="flex items-center gap-2">
                        @if (isPart) {
                          <lucide-icon [img]="Package" class="size-4 text-info"></lucide-icon>
                          <span class="badge badge-info badge-sm">Part</span>
                        } @else {
                          <lucide-icon [img]="Smartphone" class="size-4 text-warning"></lucide-icon>
                          <span class="badge badge-warning badge-sm">Device</span>
                        }
                      </div>
                    </td>

                    <!-- SKU -->
                    <td>
                      <span class="font-mono font-medium">{{ itemControl.get('sku')?.value }}</span>
                    </td>

                    <!-- Remaining -->
                    <td class="text-center">
                      <span class="badge badge-ghost">{{ itemControl.get('remaining_quantity')?.value }}</span>
                    </td>

                    <!-- To Receive Input/Display -->
                    <td class="text-center">
                      @if (isPart) {
                        <!-- Part: Direct quantity input -->
                        <div class="flex flex-col items-center">
                          <input 
                            type="number"
                            formControlName="quantity_received"
                            class="input input-bordered input-sm w-24 text-center"
                            [class.input-success]="quantity > 0 && !itemControl.get('quantity_received')?.errors && isSelected"
                            [class.input-error]="itemControl.get('quantity_received')?.invalid && itemControl.get('quantity_received')?.touched"
                            placeholder="0"
                            min="0"
                            [max]="itemControl.get('remaining_quantity')?.value"
                            [disabled]="loading() || loadingSpecificPurchase() || submitting() || !isSelected"
                          />
                          @if (itemControl.get('quantity_received')?.invalid && itemControl.get('quantity_received')?.touched) {
                            <div class="text-xs text-error mt-1 text-center">
                              @if (itemControl.get('quantity_received')?.errors?.['exceedsRemaining']) {
                                Max: {{ itemControl.get('remaining_quantity')?.value }}
                              } @else if (itemControl.get('quantity_received')?.errors?.['max']) {
                                Max: {{ itemControl.get('remaining_quantity')?.value }}
                              } @else if (itemControl.get('quantity_received')?.errors?.['invalidFormat']) {
                                Invalid number
                              } @else if (itemControl.get('quantity_received')?.errors?.['required']) {
                                Required
                              }
                            </div>
                          }
                        </div>
                      } @else {
                        <!-- Device: Show identifier count and expand button -->
                        <div class="flex items-center justify-center gap-2">
                          <span class="font-medium" [class.text-success]="identifiersCount > 0 && isSelected">
                            {{ identifiersCount }}
                          </span>
                          <button 
                            type="button"
                            class="btn btn-sm btn-ghost"
                            (click)="toggleDeviceExpanded(itemIndex)"
                            [disabled]="loading() || loadingSpecificPurchase() || submitting() || !isSelected"
                          >
                            @if (isExpanded) {
                              <lucide-icon [img]="ChevronUp" class="size-4"></lucide-icon>
                            } @else {
                              <lucide-icon [img]="ChevronDown" class="size-4"></lucide-icon>
                            }
                            {{ isExpanded ? 'Hide' : 'Scan' }}
                          </button>
                        </div>
                      }
                    </td>

                    <!-- Actions -->
                    <td>
                      <!-- Optional: Add remove button if needed -->
                    </td>
                  </tr>

                  <!-- Device Expansion Row -->
                  @if (!isPart && isExpanded) {
                    <tr [formGroupName]="itemIndex">
                      <td colspan="7" class="bg-base-200/50">
                        <div class="p-4 space-y-4">
                          <!-- Progress Bar -->
                          @let remaining = itemControl.get('remaining_quantity')?.value || 0;
                          
                          <div class="flex items-center gap-4">
                            <div class="flex-1">
                              <div class="flex justify-between text-sm mb-1">
                                <span class="font-medium">Scanned: {{ identifiersCount }} / {{ remaining }}</span>
                                @if (identifiersCount >= remaining) {
                                  <span class="text-success font-medium">âœ“ Complete</span>
                                } @else {
                                  <span class="text-base-content/60">{{ remaining - identifiersCount }} remaining</span>
                                }
                              </div>
                              <progress 
                                class="progress w-full" 
                                [class.progress-success]="identifiersCount >= remaining"
                                [class.progress-accent]="identifiersCount < remaining"
                                [value]="identifiersCount" 
                                [max]="remaining"
                              ></progress>
                            </div>
                          </div>

                          <!-- Scanner -->
                          <app-barcode-scanner
                            label="Scan IMEI/Serial"
                            placeholder="Scan or enter IMEI/Serial number..."
                            [disabled]="loading() || loadingSpecificPurchase() || submitting() || identifiersCount >= remaining || !isSelected"
                            [autoClear]="true"
                            [enableCamera]="true"
                            (scanned)="onScanResult(itemIndex, $event)"
                          ></app-barcode-scanner>

                          @if (identifiersCount >= remaining) {
                            <div class="alert alert-success">
                              <lucide-icon [img]="CheckCircle2" class="size-4"></lucide-icon>
                              <span>All required identifiers have been scanned for this device</span>
                            </div>
                          }

                          <!-- Scanned Identifiers -->
                          @if (identifiersCount > 0) {
                            <div>
                              <label class="label">
                                <span class="label-text font-medium">
                                  Scanned Identifiers ({{ identifiersCount }})
                                </span>
                              </label>
                              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                                @for (identifierControl of getIdentifiersArray(itemIndex).controls; track $index; let j = $index) {
                                  <div class="flex items-center justify-between bg-base-100 p-2 rounded border border-base-300">
                                    <span class="font-mono text-sm">{{ identifierControl.value }}</span>
                                    <button 
                                      type="button"
                                      class="btn btn-ghost btn-xs text-error"
                                      (click)="removeIdentifier(itemIndex, j)"
                                      [disabled]="loading() || loadingSpecificPurchase() || submitting()"
                                    >
                                      <lucide-icon [img]="Trash2" class="size-3"></lucide-icon>
                                    </button>
                                  </div>
                                }
                              </div>
                            </div>
                          } @else {
                            <div class="alert alert-warning">
                              <lucide-icon [img]="QrCode" class="size-4"></lucide-icon>
                              <span>Scan at least one IMEI/Serial number for this device</span>
                            </div>
                          }
                        </div>
                      </td>
                    </tr>
                  }
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    }

    <!-- Empty State -->
    @if (!selectedPurchase()) {
      <div class="alert alert-info">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Please select a supplier order to begin receiving items.</span>
      </div>
    } @else if (allItems().length === 0) {
      <div class="alert alert-warning">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <span>This purchase order has no items with remaining quantities to receive.</span>
      </div>
    }
  </div>
</app-generic-form-page>
