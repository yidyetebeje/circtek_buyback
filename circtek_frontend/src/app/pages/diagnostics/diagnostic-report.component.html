<div class="bg-base-200 min-h-screen print:bg-white" id="report-root">
  @if (report(); as r) {
    <div class="bg-base-100 print:bg-white shadow-lg rounded-lg">
      <!-- Header -->
      <div class="flex items-start justify-between p-6 border-b border-base-300">
        <div class="flex items-center gap-4">
          <img src="https://api.circtek.com/logo.png" alt="Circtek Logo" class="w-24 h-auto">
          <div>
            <h1 class="text-2xl font-bold">Diagnostic Report</h1>
            <div class="text-sm text-base-content/60">Report ID:
              <span class="font-mono bg-base-300/70 rounded px-2 py-1 text-xs ml-1">{{ r.id }}</span>
            </div>
          </div>
        </div>
        <div class="text-right">
            <div class="flex justify-end gap-2 no-print">
                <button class="btn btn-primary btn-wide" (click)="print()">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm2 0h6v3H7V4zM4 9h12v6H4V9z" clip-rule="evenodd" /></svg>
                  Download or Print
                </button>
              </div>
          <div class="text-xs text-base-content/60">Tested on:</div>
          <div class="font-semibold text-sm">{{ r.created_at | date: 'MM/dd/yyyy HH:mm:ss' }}</div>
          <!-- QR placeholder -->
          <div class="w-24 h-24 border border-base-300 rounded-lg ml-auto mt-2 flex items-center justify-center">
            <span class="text-xs text-base-content/50">QR Code</span>
          </div>
        </div>
      </div>

      <!-- Device Info -->
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card bg-base-200/60">
            <div class="card-body p-5">
              <h2 class="card-title text-lg">{{ r.model_name || 'Device' }}</h2>
              <p class="text-sm text-base-content/70">{{ r.device_storage ? (' ' + r.device_storage) : '' }} {{ r.device_color ? (' ' + r.device_color) : '' }}</p>
            </div>
          </div>
          <div class="card bg-base-200/60">
            <div class="card-body p-5">
              <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <div><span class="font-semibold">IMEI:</span> {{ r.imei || r.device_imei || 'N/A' }}</div>
                <div><span class="font-semibold">Serial:</span> {{ r.serial_number || r.device_serial || 'N/A' }}</div>
                <div><span class="font-semibold">LPN:</span> {{ r.lpn || r.device_lpn || 'N/A' }}</div>
                <div><span class="font-semibold">Battery:</span> {{ (r.battery_info?.health || 'N/A') }}</div>
                <div><span class="font-semibold">Carrier:</span> {{ (r.carrier_lock?.carrier || 'N/A') }}</div>
                <div><span class="font-semibold">OS:</span> {{ r.os_version || 'N/A' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status bar row -->
      <div class="px-6 pb-6">
        <div class="grid grid-cols-6 text-center text-sm font-semibold">
          <div class="bg-base-300/60 py-2 rounded-l-lg">FMI</div>
          <div class="bg-base-300/60 py-2">Jailbreak</div>
          <div class="bg-base-300/60 py-2">Grade</div>
          <div class="bg-base-300/60 py-2">ESN</div>
          <div class="bg-base-300/60 py-2">MDM</div>
          <div class="bg-base-300/60 py-2 rounded-r-lg">Wipe</div>
        </div>
        <div class="grid grid-cols-6 text-center border border-t-0 border-base-300 rounded-b-lg rounded-t-none text-sm">
          <div class="py-2 font-medium">Off</div>
          <div class="py-2 font-medium">No</div>
          <div class="py-2 font-medium">-</div>
          <div class="py-2 font-medium">Clean</div>
          <div class="py-2 font-medium">Off</div>
          <div class="py-2 font-medium">Passed</div>
        </div>
      </div>

      <!-- Tests Matrix -->
      <div class="px-6 pb-6">
        <h3 class="text-lg font-bold mb-4">Functional Tests</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">
          @for (name of parseList(r.passed_components); track name) {
            <div class="flex items-center justify-between p-2 rounded-md hover:bg-base-200/50">
              <span class="font-medium">{{ name }}</span>
              <span class="text-success">✓ Passed</span>
            </div>
          }
          @for (name of parseList(r.pending_components); track name) {
            <div class="flex items-center justify-between p-2 rounded-md hover:bg-base-200/50">
              <span class="font-medium">{{ name }}</span>
              <span class="text-warning">● Pending</span>
            </div>
          }
          @for (name of parseList(r.failed_components); track name) {
            <div class="flex items-center justify-between p-2 rounded-md hover:bg-base-200/50">
              <span class="font-medium">{{ name }}</span>
              <span class="text-error">✗ Failed</span>
            </div>
          }
        </div>
      </div>

      <!-- Footer summary -->
      <div class="px-6 py-4 bg-base-200/60 rounded-b-lg">
        <div class="text-sm font-semibold">
          <span>Overall Result:</span>
          <span class="ml-2">
            @if (parseList(r.failed_components).length) {
              <span class="badge badge-error">Failed</span>
            } @else if (parseList(r.pending_components).length) {
              <span class="badge badge-warning">Pending</span>
            } @else {
              <span class="badge badge-success">Passed</span>
            }
          </span>
        </div>
        <div class="text-xs text-base-content/60 mt-1">
          @if (parseList(r.failed_components).length) {
            <span>This device has one or more failed components.</span>
          } @else if (parseList(r.pending_components).length) {
            <span>This device has pending tests.</span>
          } @else {
            <span>This device has passed all tests with no errors.</span>
          }
        </div>
      </div>
    </div>
  } @else {
    <div class="p-6 text-center text-base-content/60">
      @if(loading()) {
        <span class="loading loading-spinner"></span>
        <p>Loading report...</p>
      } @else {
        <p>Report not found.</p>
      }
    </div>
  }
</div>