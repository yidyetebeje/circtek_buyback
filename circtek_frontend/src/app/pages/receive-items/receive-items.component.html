<app-generic-form-page
  [title]="title()"
  [subtitle]="subtitle()"
  [loading]="loading()"
  [submitting]="submitting()"
  [error]="error()"
  [form]="form()"
  [fields]="fields()"
  [actions]="actions()"
  [submitLabel]="'Receive Items'"
  (formSubmit)="onSubmit()"
  (actionClick)="onActionClick($event)"
>
  <!-- Additional Receiving Fields -->
  @if (selectedPurchase()) {
    <div class="mt-8 space-y-6">
      <!-- Item Details -->
      @if (form().get('selected_item_id')?.value) {
        <div class="bg-base-100 rounded-xl border border-base-300/20 p-4">
          <h3 class="text-base font-semibold mb-3">Item Details</h3>
          @if (getSelectedItem(); as item) {
            <div class="flex flex-wrap gap-4">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-base-content/70">SKU:</span>
                <span class="font-semibold">{{ item.sku }}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-base-content/70">Type:</span>
                <span class="badge {{ item.is_part ? 'badge-secondary' : 'badge-accent' }} badge-sm">
                  {{ item.is_part ? 'Part' : 'Device' }}
                </span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-base-content/70">Remaining:</span>
                <span class="font-semibold text-primary">{{ item.remaining_quantity }}</span>
              </div>
            </div>
          }
        </div>
      }

      <!-- Device Scanner (for devices only) -->
      @if (form().get('selected_item_id')?.value && !isItemPart()) {
        <div class="bg-base-100 rounded-xl border border-base-300/20 p-4">
          <h3 class="text-base font-semibold mb-3">Scan Device IMEI/Serial</h3>
          <div class="w-full">
            <app-barcode-scanner
              label=""
              placeholder="Scan or enter IMEI/Serial"
              [autoClear]="true"
              (scanned)="onDeviceScan($event)"
            />
          </div>
        </div>
      }

      <!-- Identifiers Section -->
      @if (identifiersArray.length > 0) {
        <div class="bg-base-100 rounded-xl border border-base-300/20 p-6" [formGroup]="form()">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">
              {{ isItemPart() ? 'Part Identifiers' : 'Device Identifiers' }}
            </h3>
            <span class="badge badge-info">{{ identifiersArray.length }} items</span>
          </div>
          
          <div class="space-y-3" formArrayName="identifiers">
            @for (identifier of identifiersArray.controls; track $index) {
              <div class="flex gap-3 items-center">
                <div class="badge badge-outline">{{ $index + 1 }}</div>
                <input
                  type="text"
                  [formControlName]="$index"
                  class="input input-bordered flex-1"
                  [placeholder]="isItemPart() ? 'Part identifier' : 'IMEI/Serial'"
                />
                <button
                  type="button"
                  class="btn btn-ghost btn-circle btn-sm text-error hover:bg-error/10"
                  (click)="removeIdentifier($index)"
                  title="Remove identifier"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            }
          </div>

          <!-- Add Identifier Button (for parts) -->
          @if (isItemPart()) {
            <div class="flex justify-center mt-4">
              <button
                type="button"
                class="btn btn-outline btn-primary gap-2"
                (click)="addIdentifier()"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Identifier
              </button>
            </div>
          }
        </div>
      }



      <!-- Receiving Picture Upload -->
      <div class="bg-base-100 rounded-xl border border-base-300/20 p-4" [formGroup]="form()">
        <h3 class="text-base font-semibold mb-3">Receiving Picture (Optional)</h3>
        <app-file-upload
          [accept]="'image/*'"
          [folder]="'purchases'"
          formControlName="receiving_picture"
        />
        <p class="text-sm text-base-content/60 mt-2">Upload a photo of the received items</p>
      </div>
    </div>
  }
</app-generic-form-page>
