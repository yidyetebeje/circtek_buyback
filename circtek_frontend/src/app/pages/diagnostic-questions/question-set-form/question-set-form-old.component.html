<app-generic-form-page
  [title]="title()"
  [subtitle]="subtitle()"
  [form]="questionSetForm()"
  [fields]="fields()"
  [actions]="actions()"
  [loading]="loading()"
  [submitting]="submitting()"
  [error]="errorMessage()"
  [showBackButton]="true"
  [submitLabel]="submitLabel()"
  backUrl="/diagnostic-questions"
  (formSubmit)="onFormSubmit($event)"
  (actionClick)="onActionClick($event)"
  (backClick)="onBackClick()"
></app-generic-form-page>

<!-- Questions Management Section (only in edit mode) -->
@if (isEditMode()) {
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h3 class="card-title text-lg mb-4">Questions in this Set</h3>
        <p class="text-sm text-base-content/70 mb-4">
          Add questions to this set. Testers will be asked these questions in order when this set is assigned to them.
        </p>

        <!-- Add Question to Set -->
        <div class="flex gap-2 mb-6">
          <select
            class="select select-bordered select-accent flex-1"
            (change)="onQuestionSelect($event)"
            [value]="selectedQuestionId() ?? ''"
            [disabled]="questionsLoading()"
          >
            <option value="">Select a question to add…</option>
            @for (question of filteredAvailableQuestions; track question.id) {
              <option [value]="question.id">
                {{ question.question_text }}
              </option>
            }
          </select>
          <button
            class="btn btn-accent"
            (click)="addQuestion()"
            [disabled]="!selectedQuestionId() || questionsLoading()"
          >
            @if (questionsLoading()) {
              <span class="loading loading-spinner loading-sm"></span>
            }
            Add Question
          </button>
        </div>

        <!-- Questions List -->
        @if (questionsLoading() && setQuestions().length === 0) {
          <div class="flex items-center justify-center py-8">
            <span class="loading loading-spinner loading-md mr-2"></span>
            <span class="text-base-content/70">Loading questions...</span>
          </div>
        } @else if (setQuestions().length === 0) {
          <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>No questions in this set yet. Add questions to create a complete diagnostic questionnaire.</span>
          </div>
        } @else {
          <div class="space-y-3">
            @for (question of setQuestions(); track question.id; let i = $index) {
              <div class="p-4 bg-base-200/30 rounded-lg border border-base-300/20">
                <div class="flex items-start gap-3">
                  <!-- Order Controls -->
                  <div class="flex flex-col gap-1 pt-1">
                    <button
                      class="btn btn-ghost btn-xs"
                      (click)="moveQuestionUp(i)"
                      [disabled]="i === 0 || questionsLoading()"
                      title="Move up"
                    >
                      ▲
                    </button>
                    <button
                      class="btn btn-ghost btn-xs"
                      (click)="moveQuestionDown(i)"
                      [disabled]="i === setQuestions().length - 1 || questionsLoading()"
                      title="Move down"
                    >
                      ▼
                    </button>
                  </div>

                  <!-- Question Number -->
                  <div class="badge badge-neutral badge-lg">{{ i + 1 }}</div>

                  <!-- Question Content -->
                  <div class="flex-1 min-w-0">
                    <div class="font-medium mb-2">{{ question.question_text }}</div>
                    @if (question.description) {
                      <div class="text-sm text-base-content/60 mb-2">{{ question.description }}</div>
                    }
                    
                    <!-- Options -->
                    @if (question.options && question.options.length > 0) {
                      <div class="mt-2 space-y-1">
                        <div class="text-xs text-base-content/60 font-medium">Options:</div>
                        @for (option of question.options; track option.id; let optIdx = $index) {
                          <div class="text-sm pl-4 flex items-center gap-2">
                            <span class="badge badge-sm">{{ optIdx + 1 }}</span>
                            <span>{{ option.option_text }}</span>
                          </div>
                        }
                      </div>
                    } @else {
                      <div class="alert alert-warning alert-sm mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        <span class="text-xs">This question has no options yet</span>
                      </div>
                    }
                  </div>

                  <!-- Remove Button -->
                  <button
                    class="btn btn-ghost btn-sm text-error"
                    (click)="removeQuestion(question.id)"
                    [disabled]="questionsLoading()"
                    title="Remove from set"
                  >
                    Remove
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
}
